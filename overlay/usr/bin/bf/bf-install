#!/bin/bash

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Disable Debian interactive frontend.
#======================================================================================================================

export DEBIAN_FRONTEND=noninteractive
export TERM=dumb


#======================================================================================================================
# Set permissions.
#======================================================================================================================

chmod +x /usr/bin/esh
chmod +x ${BF_BIN}/*

bf-ch -o root:root -m 1777 /etc/bf/src
bf-ch -o root:root -r /etc/bf/templates && \
    bf-ch -m 0444 -t f /etc/bf/templates && \
    bf-ch -m 0555 -t d /etc/bf/templates
bf-ch -o root:root -m 1777 /tmp
bf-ch -o root:root -m 0555 -t f /usr/lib/bf


#======================================================================================================================
# Store image version.
#======================================================================================================================

echo "${BF_IMAGE/docker-/}" > /BF_IMAGE
echo "${BF_VERSION}" > /BF_VERSION
bf-image


#======================================================================================================================
# Run install script in /tmp and then perform cleanup.
#======================================================================================================================

INSTALL=/tmp/install
[[ ! -f ${INSTALL} ]] && bf-error "${INSTALL} does not exist."

chmod +x ${INSTALL} && ${INSTALL}
bf-done


#======================================================================================================================
# Perform cleanup.
#======================================================================================================================

bf-clear
