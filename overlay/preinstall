#!/usr/bin/env sh

set -euo pipefail


#======================================================================================================================
# Move Nushell config
#======================================================================================================================

NU=/etc/nu
CFG=/root/.config/nushell
mv ${CFG}/config.nu ${NU}
mv ${CFG}/env.nu ${NU}


#======================================================================================================================
# Link Nushell scripts directory
#======================================================================================================================

ln ${NU}/config.nu ${CFG}/config.nu
ln ${NU}/env.nu ${CFG}/env.nu
ln -s ${NU}/scripts ${CFG}/scripts


#======================================================================================================================
# Delete Nushell plugins
#======================================================================================================================

rm -rf ${CFG}/plugins


#======================================================================================================================
# Set permissions
#======================================================================================================================

echo "Setting bf-install permissions."
chmod 0500 /usr/bin/bf/bf-install


#======================================================================================================================
# Test Nushell version
#======================================================================================================================

echo "Testing Nushell version."
INSTALLED_VERSION=$(nu -v 2> /dev/null)
if [ "${INSTALLED_VERSION}" != "${NUSHELL_VERSION}" ] ; then
    echo "Detected Nushell version '${INSTALLED_VERSION}' - expecting '${NUSHELL_VERSION}'."
    exit 1
fi
